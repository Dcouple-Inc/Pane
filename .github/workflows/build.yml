name: Build & Release

on:
  push:
    branches: [release]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to GitHub Releases'
        type: boolean
        default: false

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest]
        include:
          - os: macos-latest
            release_cmd: release:mac:universal
            ci_cmd: build:mac:ci
            artifact_path: |
              dist-electron/*.dmg
              dist-electron/*.zip
              dist-electron/latest-mac.yml
          - os: ubuntu-latest
            release_cmd: release:linux
            ci_cmd: build:linux:ci
            artifact_path: |
              dist-electron/*.deb
              dist-electron/*.AppImage
              dist-electron/latest-linux.yml
              dist-electron/latest-linux-arm64.yml

    runs-on: ${{ matrix.os }}
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - uses: pnpm/action-setup@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '22.15.1'
        cache: 'pnpm'

    - uses: actions/cache@v4
      with:
        path: |
          ~/.cache/electron
          ~/.cache/electron-builder
        key: ${{ runner.os }}-electron-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: ${{ runner.os }}-electron-

    - run: pnpm install

    - name: Build and optionally publish
      run: |
        if [[ "${{ github.ref_type }}" == "tag" ]] || [[ "${{ inputs.publish }}" == "true" ]]; then
          echo "Release build — publishing to GitHub Releases"
          pnpm run ${{ matrix.release_cmd }}
        else
          echo "CI build — artifacts only"
          pnpm run ${{ matrix.ci_cmd }}
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CSC_IDENTITY_AUTO_DISCOVERY: 'false'
        CSC_DISABLE: 'true'

    - run: ls -la dist-electron/

    - uses: actions/upload-artifact@v4
      with:
        name: pane-${{ matrix.os }}-${{ github.ref_name }}
        path: ${{ matrix.artifact_path }}
        if-no-files-found: error
        retention-days: 30

  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
    - uses: pnpm/action-setup@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '22.15.1'
        cache: 'pnpm'
    - uses: actions/cache@v4
      with:
        path: |
          ~/AppData/Local/electron/Cache
          ~/AppData/Local/electron-builder/Cache
        key: windows-electron-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: windows-electron-
    - run: pnpm install

    - name: Build and optionally publish
      run: |
        if ("${{ github.ref_type }}" -eq "tag" -or "${{ inputs.publish }}" -eq "true") {
          Write-Host "Release build — publishing to GitHub Releases"
          pnpm run release:win
        } else {
          Write-Host "CI build — artifacts only"
          node scripts/build-win.js both
        }
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - run: dir dist-electron

    - uses: actions/upload-artifact@v4
      with:
        name: pane-windows-${{ github.ref_name }}
        path: |
          dist-electron/*.exe
          dist-electron/latest.yml
        if-no-files-found: error
        retention-days: 30
